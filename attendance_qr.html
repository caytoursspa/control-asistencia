<!doctype html>
<!--
Control de Asistencia — Versión totalmente web (todo en el navegador)
Archivo: attendance_qr.html (guárdalo y ábrelo en cualquier navegador moderno)
Características:
- Importa una lista de personas desde CSV ( columnas sugeridas: ID,Name,Authorized )
- Escanea QR con la cámara (usa @zxing/browser). El QR puede contener sólo el ID o un JSON {"id":"..."}
- Registra localmente (localStorage) cada marcación con timestamp, id, name, authorized, rawQR
- Muestra historial y contador de veces por persona
- Permite descargar el registro (CSV) y descargar/guardar la lista de personas
- Funciona totalmente en cliente: no requiere servidor ni Google Sheets

Instrucciones rápidas:
1) Guarda este archivo como `attendance_qr.html` y ábrelo en Chrome/Edge/Firefox móvil o escritorio.
2) Importa la lista de empleados (CSV) o crea manualmente.
3) Presiona "Iniciar cámara" y escanea los QR.
4) Descarga el registro con el botón "Descargar CSV" cuando quieras.

Nota: para mayor seguridad, hospeda el archivo en un servidor HTTPS si lo vas a usar en móviles (las cámaras en algunos navegadores requieren HTTPS). Si lo abres desde el sistema de archivos en algunos navegadores, la cámara puede no funcionar.
-->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Asistencia (Standalone)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:980px;margin:12px auto;padding:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;flex:1 1 300px;box-shadow:0 2px 6px rgba(0,0,0,0.03)}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #eee;padding:6px;font-size:13px}
    #video{width:100%;height:auto;border-radius:6px;background:#000}
    .authorized{background:#e6ffed}
    .unauthorized{background:#ffecec}
    button{cursor:pointer}
    input[type=file]{display:block}
    small{color:#666}
  </style>
</head>
<body>
  <h2>Control de Asistencia — Standalone</h2>
  <p>Todo en el navegador. Importa empleados (CSV), escanea QR y descarga el registro cuando quieras.</p>

  <div class="row">
    <div class="card">
      <h3>1) Lista de personas</h3>
      <input id="fileEmp" type="file" accept=".csv" />
      <small>CSV: columnas: ID,Name,Authorized (opcional)</small>
      <div style="margin-top:8px">
        <button id="addDemo">Cargar ejemplo demo</button>
        <button id="savePeople">Descargar lista (CSV)</button>
      </div>
      <div style="margin-top:8px">
        <table id="peopleTable"><thead><tr><th>ID</th><th>Nombre</th><th>Autorizado</th><th>Count</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div class="card">
      <h3>2) Lector QR</h3>
      <label for="cameraSelect">Cámara</label>
      <select id="cameraSelect"></select>
      <div style="margin-top:8px"><video id="video" autoplay muted playsinline></video></div>
      <div style="margin-top:8px">
        <button id="startCam">Iniciar cámara</button>
        <button id="stopCam" disabled>Detener</button>
      </div>
      <div style="margin-top:8px">
        <label>Entrada manual (ID o JSON)</label>
        <input id="manualInput" style="width:100%;padding:6px" placeholder='Ej: 1234 o {"id":"1234"}' />
        <button id="manualBtn">Registrar manual</button>
      </div>
      <div id="scanResult" style="margin-top:8px;padding:8px;border-radius:6px;display:none"></div>
    </div>

    <div class="card">
      <h3>3) Registro / Exportar</h3>
      <div>
        <button id="downloadCsv">Descargar registro (CSV)</button>
        <button id="clearLogs">Borrar registro</button>
      </div>
      <div style="margin-top:8px">
        <table id="logTable"><thead><tr><th>TS</th><th>ID</th><th>Nombre</th><th>Autorizado</th><th>Raw</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script>
    // Utilidades: simple CSV parse (no manejo complejo de comillas multilínea)
    function csvToArray(text){
      const lines = text.trim().split(/\r?\n/);
      const rows = lines.map(l => l.split(',').map(cell => cell.trim().replace(/^"|"$/g,'')));
      return rows;
    }
    function arrayToCsv(rows){ return rows.map(r => r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n'); }

    // State
    const LS_PEOPLE = 'asistencia_people_v1';
    const LS_LOGS = 'asistencia_logs_v1';
    let people = {}; // id -> {ID,Name,Authorized}
    let logs = []; // {ts,id,name,authorized,raw}

    // DOM
    const fileEmp = document.getElementById('fileEmp');
    const peopleTableBody = document.querySelector('#peopleTable tbody');
    const addDemo = document.getElementById('addDemo');
    const savePeople = document.getElementById('savePeople');
    const cameraSelect = document.getElementById('cameraSelect');
    const video = document.getElementById('video');
    const startCam = document.getElementById('startCam');
    const stopCam = document.getElementById('stopCam');
    const manualInput = document.getElementById('manualInput');
    const manualBtn = document.getElementById('manualBtn');
    const scanResult = document.getElementById('scanResult');
    const downloadCsv = document.getElementById('downloadCsv');
    const clearLogs = document.getElementById('clearLogs');
    const logTableBody = document.querySelector('#logTable tbody');

    // Load from localStorage
    function loadState(){
      try{ people = JSON.parse(localStorage.getItem(LS_PEOPLE) || '{}'); }catch(e){ people = {}; }
      try{ logs = JSON.parse(localStorage.getItem(LS_LOGS) || '[]'); }catch(e){ logs = []; }
      refreshPeopleTable(); refreshLogTable();
    }
    function saveState(){ localStorage.setItem(LS_PEOPLE, JSON.stringify(people)); localStorage.setItem(LS_LOGS, JSON.stringify(logs)); }

    function refreshPeopleTable(){
      peopleTableBody.innerHTML = '';
      const ids = Object.keys(people);
      ids.sort();
      ids.forEach(id=>{
        const p = people[id];
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + id + '</td><td>' + (p.Name||'') + '</td><td>' + (p.Authorized? 'Sí':'No') + '</td><td>' + countAttendance(id) + '</td>';
        peopleTableBody.appendChild(tr);
      });
    }
    function refreshLogTable(){
      logTableBody.innerHTML = '';
      logs.slice().reverse().forEach(l=>{
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + new Date(l.ts).toLocaleString() + '</td><td>' + l.id + '</td><td>' + (l.name||'') + '</td><td>' + (l.authorized? 'Sí':'No') + '</td><td>' + (l.raw||'') + '</td>';
        logTableBody.appendChild(tr);
      });
    }
    function countAttendance(id){ return logs.filter(x=>x.id==id).length; }

    // Parse CSV import
    fileEmp.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev => {
        const rows = csvToArray(ev.target.result);
        // assume first row header
        const headers = rows[0].map(h=>h.toLowerCase());
        for(let i=1;i<rows.length;i++){
          const row = rows[i];
          const obj = {};
          headers.forEach((h,idx)=>obj[h]=row[idx]||'');
          const id = obj['id'] || obj['ID'] || obj['Id'] || row[0];
          if(!id) continue;
          people[id] = {ID: id, Name: obj['name']||obj['nombre']||'', Authorized: String(obj['authorized']||obj['autorizado']||'').toUpperCase().startsWith('S') || String(obj['authorized']||'').toUpperCase()==='TRUE'};
        }
        saveState(); refreshPeopleTable();
      };
      r.readAsText(f,'utf-8');
    });

    addDemo.addEventListener('click', ()=>{
      people = {
        '1001':{ID:'1001',Name:'María Pérez',Authorized:true},
        '1002':{ID:'1002',Name:'Juan Gómez',Authorized:false},
        '1003':{ID:'1003',Name:'Luis Soto',Authorized:true}
      };
      saveState(); refreshPeopleTable();
    });

    savePeople.addEventListener('click', ()=>{
      const rows = [['ID','Name','Authorized']];
      Object.keys(people).forEach(id=> rows.push([id, people[id].Name || '', people[id].Authorized ? 'TRUE' : 'FALSE']));
      const blob = new Blob([arrayToCsv(rows)],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'people.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // Scanner
    let codeReader = null;
    let selectedDeviceId = null;

    async function listCameras(){
      try{
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';
        devices.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.text=d.label||d.deviceId; cameraSelect.appendChild(o); });
        if(devices.length) selectedDeviceId = devices[0].deviceId;
      }catch(err){ console.warn('No se pudieron listar cámaras',err); }
    }
    cameraSelect.addEventListener('change', ()=> selectedDeviceId = cameraSelect.value);

    startCam.addEventListener('click', async ()=>{
      startCam.disabled = true; stopCam.disabled = false;
      if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
      try{
        await codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err)=>{
          if(result){ handleDetected(result.text); }
        });
      }catch(e){ console.error(e); startCam.disabled=false; stopCam.disabled=true; }
    });
    stopCam.addEventListener('click', ()=>{ if(codeReader) codeReader.reset(); startCam.disabled=false; stopCam.disabled=true; });

    manualBtn.addEventListener('click', ()=>{ const v = manualInput.value && manualInput.value.trim(); if(v) handleDetected(v); });

    let lastProcessed = ''; let lastTime = 0;
    function handleDetected(raw){
      let id = raw;
      try{ const maybe = JSON.parse(raw); if(maybe && maybe.id) id = maybe.id; }catch(e){}
      const now = Date.now(); if(id===lastProcessed && (now-lastTime)<2000) return; lastProcessed=id; lastTime=now;

      const person = people[id] || null;
      const authorized = person ? !!person.Authorized : false;
      const name = person ? (person.Name||'') : '';
      const entry = {ts: new Date().toISOString(), id: id, name: name, authorized: authorized, raw: raw};
      logs.push(entry); saveState(); refreshLogTable(); refreshPeopleTable();

      // show feedback
      scanResult.style.display='block';
      scanResult.className = authorized ? 'authorized' : 'unauthorized';
      scanResult.innerHTML = '<strong>' + (name||'No registrado') + '</strong><br>ID: ' + id + '<br>Autorizado: ' + (authorized? 'Sí':'No') + '<br>' + new Date(entry.ts).toLocaleString();
    }

    // Export logs
    downloadCsv.addEventListener('click', ()=>{
      const rows = [['Timestamp','ID','Name','Authorized','Raw']];
      logs.forEach(l=> rows.push([l.ts, l.id, l.name||'', l.authorized? 'TRUE':'FALSE', l.raw||'']));
      const blob = new Blob([arrayToCsv(rows)],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='attendance_log.csv'; a.click(); URL.revokeObjectURL(url);
    });
    clearLogs.addEventListener('click', ()=>{ if(confirm('Borrar todo el registro?')){ logs=[]; saveState(); refreshLogTable(); refreshPeopleTable(); } });

    // Init
    (async ()=>{ await listCameras(); loadState(); })();
  </script>
</body>
</html>
